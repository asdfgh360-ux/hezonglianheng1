<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçºµè¿æ¨ª - åå¹¶å…­å›½</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Serif SC', serif;
            background: linear-gradient(135deg, #0c0c1a 0%, #1a1a2e 50%, #0f1a30 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
            letter-spacing: 0.3em;
            position: relative;
            display: inline-block;
        }
        
        .title::after {
            content: 'åå¹¶å…­å›½';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            letter-spacing: 0.5em;
            color: #e94560;
            background: none;
            -webkit-text-fill-color: #e94560;
        }
        
        .subtitle {
            color: #888;
            font-size: 1rem;
            margin-top: 20px;
            font-style: italic;
        }
        
        /* è­¦å‘Šæ¨ªå¹… */
        .war-banner {
            background: linear-gradient(90deg, #dc2626, #991b1b, #dc2626);
            color: #fff;
            padding: 12px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
            animation: pulse 2s infinite;
            font-weight: 700;
            letter-spacing: 2px;
        }
        
        .war-banner.active {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .conquest-progress {
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            text-align: center;
        }
        
        .progress-title {
            color: #ffd700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255,215,0,0.3);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e94560 0%, #ff6b35 50%, #ffd700 100%);
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: 700;
            color: #000;
            text-shadow: 0 0 2px rgba(255,255,255,0.5);
        }
        
        .conquest-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .conquest-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resources {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .resource-item {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        
        .resource-item:hover {
            transform: translateY(-3px);
            border-color: rgba(233, 69, 96, 0.3);
        }
        
        .resource-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .resource-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #ffd700;
        }
        
        .resource-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }
        
        .resource-change {
            font-size: 0.75rem;
            color: #4ade80;
            margin-top: 2px;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
        }
        
        .map-container {
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,215,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .section-title {
            color: #ffd700;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .turn-badge {
            background: linear-gradient(135deg, #e94560, #ff6b35);
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .states-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .state-card {
            background: linear-gradient(145deg, rgba(20,20,40,0.9), rgba(10,10,25,0.9));
            border: 2px solid;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .state-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: currentColor;
        }
        
        .state-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .state-card.selected {
            box-shadow: 0 0 0 3px #ffd700, 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(1.02);
        }
        
        .state-card.annexed {
            opacity: 0.4;
            filter: grayscale(0.8);
            border-color: #333 !important;
        }
        
        .state-card.independent {
            border-color: #00d9ff;
            box-shadow: 0 0 15px rgba(0,217,255,0.1);
        }
        
        .state-card.vassal {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255,215,0,0.1);
            background: linear-gradient(145deg, rgba(40,30,10,0.9), rgba(30,20,5,0.9));
        }
        
        .state-card.allied-against {
            border-color: #e94560;
            box-shadow: 0 0 15px rgba(233,69,96,0.2);
        }
        
        .state-card.being-attacked {
            animation: attackPulse 1.5s infinite;
            border-color: #dc2626;
        }
        
        /* å¤§å›½ç‰¹æ®Šæ ·å¼ */
        .state-card.great-power {
            border-color: #9c27b0;
            box-shadow: 0 0 20px rgba(156,39,176,0.3);
        }
        
        .state-card.great-power::after {
            content: 'â˜…å¤§å›½';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.65rem;
            color: #9c27b0;
            background: rgba(156,39,176,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        @keyframes attackPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(220,38,38,0.5); }
            50% { box-shadow: 0 0 20px rgba(220,38,38,0.8); }
        }
        
        .state-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .state-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
        }
        
        .state-status-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .badge-independent {
            background: rgba(0,217,255,0.2);
            color: #00d9ff;
        }
        
        .badge-vassal {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
        }
        
        .badge-annexed {
            background: rgba(100,100,100,0.3);
            color: #666;
        }
        
        .badge-allied {
            background: rgba(233,69,96,0.2);
            color: #e94560;
        }
        
        /* è·ç¦»å’Œå¤§å°æ ‡ç­¾æ ·å¼ */
        .distance-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .distance-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .distance-near .distance-icon {
            background: #ef4444;
            box-shadow: 0 0 5px #ef4444;
        }
        
        .distance-near {
            color: #ef4444;
        }
        
        .distance-mid .distance-icon {
            background: #f59e0b;
            box-shadow: 0 0 5px #f59e0b;
            transform: rotate(45deg);
            border-radius: 2px;
            width: 7px;
            height: 7px;
        }
        
        .distance-mid {
            color: #f59e0b;
        }
        
        .distance-far .distance-icon {
            background: #22c55e;
            box-shadow: 0 0 5px #22c55e;
        }
        
        .distance-far {
            color: #22c55e;
        }
        
        .size-tag {
            color: #666;
            font-weight: normal;
        }
        
        .state-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            color: #aaa;
        }
        
        .stat-value-highlight {
            color: #fff;
            font-weight: 600;
        }
        
        .state-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 3px;
            overflow: hidden;
        }
        
        .state-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .fill-power {
            background: linear-gradient(90deg, #00d9ff, #0099cc);
        }
        
        .fill-stability {
            background: linear-gradient(90deg, #4ade80, #22c55e);
        }
        
        .fill-resistance {
            background: linear-gradient(90deg, #ffd700, #e94560);
        }
        
        .war-duration {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.75rem;
            color: #dc2626;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }
        
        .alliance-indicator {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.75rem;
            color: #e94560;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .action-panel, .info-panel, .log-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .target-info {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .target-info.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .target-name {
            font-size: 1.3rem;
            color: #ffd700;
            font-weight: 700;
        }
        
        .target-type {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }
        
        .action-btn {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-family: 'Noto Serif SC', serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }
        
        .action-btn:hover::after {
            left: 100%;
        }
        
        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-diplomacy {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }
        
        .btn-bribe {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fff;
        }
        
        .btn-subvert {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: #fff;
        }
        
        .btn-military {
            background: linear-gradient(135deg, #dc2626, #b91d1d);
            color: #fff;
        }
        
        .btn-annex {
            background: linear-gradient(135deg, #e94560, #be123c);
            color: #fff;
            font-size: 1.1rem;
            padding: 15px;
            margin-top: 10px;
            border: 2px solid rgba(255,215,0,0.5);
        }
        
        .btn-endturn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            margin-top: 10px;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .cost-tag {
            margin-left: auto;
            font-size: 0.8rem;
            opacity: 0.9;
            background: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .info-label {
            color: #666;
            font-size: 0.75rem;
        }
        
        .info-value {
            color: #fff;
            font-weight: 600;
        }
        
        .log-content {
            max-height: 250px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        
        .log-entry {
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid;
            background: rgba(255,255,255,0.03);
            border-radius: 0 5px 5px 0;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .log-entry.diplomacy { border-left-color: #3b82f6; }
        .log-entry.military { border-left-color: #dc2626; }
        .log-entry.economy { border-left-color: #f59e0b; }
        .log-entry.event { border-left-color: #ffd700; }
        .log-entry.annex { border-left-color: #e94560; background: rgba(233,69,96,0.1); }
        .log-entry.coalition { border-left-color: #dc2626; background: rgba(220,38,38,0.15); font-weight: 600; }
        .log-entry.warning { border-left-color: #f59e0b; background: rgba(245,158,11,0.1); }
        .log-entry.strategy { border-left-color: #9c27b0; background: rgba(156,39,176,0.1); }
        
        .log-time {
            font-size: 0.75rem;
            color: #666;
            margin-right: 5px;
        }
        
        .game-over {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            text-align: center;
            padding: 40px;
        }
        
        .game-over.show {
            display: flex;
        }
        
        .victory-title {
            font-size: 4rem;
            background: linear-gradient(45deg, #ffd700, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-shadow: 0 0 60px rgba(255,215,0,0.5);
        }
        
        .defeat-title {
            font-size: 4rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .game-over-desc {
            font-size: 1.2rem;
            color: #aaa;
            max-width: 600px;
            line-height: 1.8;
            margin-bottom: 30px;
        }
        
        .final-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
        }
        
        .final-stat {
            text-align: center;
        }
        
        .final-value {
            font-size: 2rem;
            color: #ffd700;
            font-weight: 700;
        }
        
        .final-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .restart-btn {
            padding: 15px 50px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #ffd700, #ff6b35);
            border: none;
            border-radius: 30px;
            color: #1a1a2e;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .restart-btn:hover {
            transform: scale(1.05);
        }
        
        /* åˆçºµè­¦å‘Šå¼¹çª— */
        .coalition-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border: 2px solid #dc2626;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            z-index: 2000;
            display: none;
            box-shadow: 0 0 50px rgba(220,38,38,0.5);
            text-align: center;
        }
        
        .coalition-alert.show {
            display: block;
            animation: alertPop 0.5s ease;
        }
        
        @keyframes alertPop {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .coalition-title {
            color: #dc2626;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .coalition-desc {
            color: #aaa;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .coalition-btn {
            background: #dc2626;
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-family: 'Noto Serif SC', serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .coalition-btn:hover {
            background: #b91d1d;
            transform: scale(1.05);
        }
        
        /* è¾¹å¢ƒå‘Šæ€¥å¼¹çª—æ ·å¼ */
        .border-crisis-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border: 2px solid #8b5cf6;
            border-radius: 20px;
            padding: 35px;
            max-width: 500px;
            z-index: 2000;
            display: none;
            box-shadow: 0 0 60px rgba(139,92,246,0.4);
            text-align: center;
        }
        
        .border-crisis-alert.show {
            display: block;
            animation: alertPop 0.5s ease;
        }
        
        .border-crisis-title {
            color: #8b5cf6;
            font-size: 2rem;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .border-crisis-content {
            color: #aaa;
            line-height: 1.8;
            margin-bottom: 25px;
            font-size: 1rem;
        }
        
        .border-crisis-content .highlight {
            color: #ef4444;
            font-weight: 700;
        }
        
        .loss-stats {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-around;
        }
        
        .loss-stat {
            text-align: center;
        }
        
        .loss-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .loss-value {
            color: #ef4444;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .loss-label {
            color: #666;
            font-size: 0.8rem;
            margin-top: 3px;
        }
        
        .strategy-tip {
            background: rgba(245,158,11,0.1);
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            border-radius: 0 8px 8px 0;
            color: #fbbf24;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .strategy-tip::before {
            content: 'ğŸ’¡ ';
        }
        
        .border-crisis-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: #fff;
            border: none;
            padding: 12px 40px;
            border-radius: 8px;
            font-family: 'Noto Serif SC', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .border-crisis-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: scale(1.05);
        }
        
        /* ç­–ç•¥æç¤ºå¼¹çª— */
        .strategy-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border: 2px solid #9c27b0;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            z-index: 2000;
            display: none;
            box-shadow: 0 0 50px rgba(156,39,176,0.5);
            text-align: center;
        }
        
        .strategy-alert.show {
            display: block;
            animation: alertPop 0.5s ease;
        }
        
        .strategy-title {
            color: #9c27b0;
            font-size: 1.6rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .strategy-desc {
            color: #aaa;
            line-height: 1.8;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .strategy-btn {
            background: #9c27b0;
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-family: 'Noto Serif SC', serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .strategy-btn:hover {
            background: #7b1fa2;
            transform: scale(1.05);
        }
        
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .resources {
                grid-template-columns: repeat(3, 1fr);
            }
            .states-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .title { font-size: 2rem; }
            .resources { grid-template-columns: repeat(2, 1fr); }
            .states-grid { grid-template-columns: 1fr; }
            .final-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">åˆçºµè¿æ¨ª</h1>
            <p class="subtitle">è¿œäº¤è¿‘æ”»ï¼Œå„ä¸ªå‡»ç ´ï¼Œåå¹¶å…­å›½ï¼Œä¸€ç»Ÿå¤©ä¸‹</p>
        </div>
        
        <div class="war-banner" id="warBanner">
            âš ï¸ åˆçºµè­¦æŠ¥ï¼šå¤šå›½ç»„æˆæŠ—ç§¦è”å†›ï¼Œæ­£åœ¨åæ”»ï¼âš ï¸
        </div>
        
        <div class="conquest-progress">
            <div class="progress-title">
                <span>ğŸ›ï¸ ç»Ÿä¸€å¤§ä¸šè¿›åº¦</span>
                <span id="progressText">0/6 å›½</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <div class="conquest-stats">
                <div class="conquest-stat">
                    <span class="stat-icon">âš”ï¸</span>
                    <span>å·²åå¹¶: <b id="annexedCount" style="color:#e94560">0</b></span>
                </div>
                <div class="conquest-stat">
                    <span class="stat-icon">ğŸ³ï¸</span>
                    <span>é™„åº¸å›½: <b id="vassalCount" style="color:#ffd700">0</b></span>
                </div>
                <div class="conquest-stat">
                    <span class="stat-icon">ğŸ›¡ï¸</span>
                    <span>ç‹¬ç«‹å›½: <b id="independentCount" style="color:#00d9ff">6</b></span>
                </div>
            </div>
        </div>
        
        <div class="resources">
            <div class="resource-item">
                <div class="resource-icon">ğŸ’°</div>
                <div class="resource-value" id="resGold">1000</div>
                <div class="resource-label">å›½åº“èµ„é‡‘</div>
                <div class="resource-change" id="goldChange">+100/å¹´</div>
            </div>
            <div class="resource-item">
                <div class="resource-icon">âš”ï¸</div>
                <div class="resource-value" id="resArmy">100</div>
                <div class="resource-label">ç§¦å†›å…µåŠ›</div>
                <div class="resource-change" id="armyChange">+40/å¹´</div> <!-- æ”¹ä¸º40 -->
            </div>
            <div class="resource-item">
                <div class="resource-icon">ğŸ–ï¸</div>
                <div class="resource-value" id="resPrestige">50</div>
                <div class="resource-label">è™ç‹¼ä¹‹å¨</div>
                <div class="resource-change" style="color:#666">å½±å“è‡£æœé€Ÿåº¦</div>
            </div>
            <div class="resource-item">
                <div class="resource-icon">ğŸ˜¤</div>
                <div class="resource-value" id="resFatigue">20</div>
                <div class="resource-label">å…­å›½æ•Œæ„</div>
                <div class="resource-change" style="color: rgb(74, 222, 128);" id="hostilityTrend">â†“ å¯æ§</div>
            </div>
            <div class="resource-item">
                <div class="resource-icon">ğŸ“œ</div>
                <div class="resource-value" id="resTurn">1</div>
                <div class="resource-label">æ‰§æ”¿å¹´æ•°</div>
                <div class="resource-change" style="color:#666">å†å²è¿›ç¨‹</div>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="map-container">
                <div class="section-header">
                    <div class="section-title">
                        <span>ğŸ—ºï¸</span>
                        <span>æˆ˜å›½å±€åŠ¿å›¾</span>
                    </div>
                    <div class="turn-badge" id="turnBadge">å…¬å…ƒå‰ 356 å¹´</div>
                </div>
                
                <div class="states-grid" id="statesGrid"></div>
                
                <div class="log-panel" style="margin-top: 20px;">
                    <div class="section-title" style="margin-bottom:15px;font-size:1.1rem;">
                        <span>ğŸ“œ</span>
                        <span>å²è®° Â· ç§¦æœ¬çºª</span>
                    </div>
                    <div class="log-content" id="logContent"></div>
                </div>
            </div>
            
            <div class="side-panel">
                <div class="action-panel">
                    <div class="section-title">
                        <span>âš¡</span>
                        <span>æˆ˜ç•¥å†³ç­–</span>
                    </div>
                    
                    <div class="target-info" id="targetInfo">
                        <div class="target-header">
                            <span class="target-name" id="targetName">--</span>
                            <span class="target-type" id="targetStatus">æœªé€‰æ‹©</span>
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">å›½åŠ›è¯„ä¼°</span>
                                <span class="info-value" id="targetPower">--</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æŠµæŠ—æ„å¿—</span>
                                <span class="info-value" id="targetResistance">--</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">å½“å‰çŠ¶æ€</span>
                                <span class="info-value" id="targetState">--</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">åå¹¶éš¾åº¦</span>
                                <span class="info-value" id="targetDifficulty" style="color:#e94560">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="action-btn btn-diplomacy" id="btnDiplomacy" onclick="game.act('diplomacy')" disabled>
                        <span>ğŸ¤</span>
                        <span>å¤–äº¤æ–½å‹</span>
                        <span class="cost-tag">-150ğŸ’°</span>
                    </button>
                    
                    <button class="action-btn btn-bribe" id="btnBribe" onclick="game.act('bribe')" disabled>
                        <span>ğŸ’</span>
                        <span>é‡é‡‘æ”¶ä¹°</span>
                        <span class="cost-tag">-250ğŸ’°</span>
                    </button>
                    
                    <button class="action-btn btn-subvert" id="btnSubvert" onclick="game.act('subvert')" disabled>
                        <span>ğŸ—¡ï¸</span>
                        <span>é—´è°æ¸—é€</span>
                        <span class="cost-tag">-200ğŸ’° -10âš”ï¸</span>
                    </button>
                    
                    <button class="action-btn btn-military" id="btnMilitary" onclick="game.act('military')" disabled>
                        <span>âš”ï¸</span>
                        <span>å†›äº‹æ‰“å‡»</span>
                        <span class="cost-tag" id="militaryCost">-40âš”ï¸</span>
                    </button>
                    
                    <button class="action-btn btn-annex" id="btnAnnex" onclick="game.act('annex')" disabled>
                        <span>ğŸ›ï¸</span>
                        <span id="annexBtnText">å¼ºè¡Œåå¹¶</span>
                        <span class="cost-tag" id="annexBtnCost">å¤§è§„æ¨¡æˆ˜äº‰</span>
                    </button>
                    
                    <button class="action-btn btn-endturn" onclick="game.endTurn()">
                        <span>â³</span>
                        <span>ç»“æŸæœ¬å¹´</span>
                        <span class="cost-tag">ä¼‘å…»ç”Ÿæ¯</span>
                    </button>
                </div>
                
                <div class="info-panel">
                    <div class="section-title" style="font-size:1rem;">
                        <span>ğŸ“‹</span>
                        <span>æˆ˜ç•¥æŒ‡å—</span>
                    </div>
                    <div style="font-size:0.85rem;line-height:1.8;color:#aaa;">
                        <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                            <b style="color:#ffd700">é™„åº¸æœºåˆ¶ï¼š</b><br>
                            å½“å›½å®¶æŠµæŠ—&lt;20ä¸”å›½åŠ›&lt;60%æ—¶ï¼Œå¤–äº¤æ–½å‹å¯ä½¿å…¶è‡£æœã€‚<br>
                            <span style="color:#ffd700">é™„åº¸å›½å¯è¢«åå¹¶ï¼ˆéš¾åº¦-30%ï¼‰ï¼Œä¸”æ¯å¹´çº³è´¡ã€‚</span>
                        </div>
                        <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                            <b style="color:#dc2626">åˆçºµåæ”»ï¼š</b><br>
                            å¯¹ä¸€å›½ç”¨å…µè¶…è¿‡2æ¬¡ï¼Œå…¶ä»–å›½å®¶ä¼šè­¦è§‰ã€‚<br>
                            è¶…è¿‡3æ¬¡æœªä¸‹ï¼Œå¯èƒ½è§¦å‘<span style="color:#dc2626">å…­å›½åˆçºµè”å†›åæ”»</span>ï¼
                        </div>
                        <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1);">
                            <b style="color:#ef4444">âš ï¸ è¿œäº¤è¿‘æ”»ï¼š</b><br>
                            è¿œå¾<span style="color:#22c55e">è¿œå›½</span>æ—¶ï¼Œè‹¥<span style="color:#ef4444">è¿‘é‚»</span>æœªå¹³ï¼Œè¾¹å¢ƒå¿…é­è¢­å‡»ï¼<br>
                            å»ºè®®å…ˆç­è¿‘é‚»å°å›½ï¼Œå†å›¾è¿œå›½ã€‚
                        </div>
                        <div>
                            <b style="color:#9c27b0">â˜… å¤§å›½å¨èƒï¼š</b><br>
                            <span style="color:#9c27b0">æ¥šå›½ã€é½å›½</span>ä¹ƒå½“ä¸–å¤§å›½ï¼Œå®åŠ›é›„åšï¼Œè´¸ç„¶æ”»ä¼æŸè€—å·¨å¤§ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆçºµè­¦å‘Šå¼¹çª— -->
    <div class="overlay" id="overlay"></div>
    <div class="coalition-alert" id="coalitionAlert">
        <div class="coalition-title">ğŸš¨ åˆçºµè”å†›æ¥è¢­ï¼</div>
        <div class="coalition-desc" id="coalitionDesc"></div>
        <button class="coalition-btn" onclick="game.closeCoalitionAlert()">æ•´å†›è¿æˆ˜</button>
    </div>
    
    <!-- è¾¹å¢ƒå‘Šæ€¥å¼¹çª— -->
    <div class="border-crisis-alert" id="borderCrisisAlert">
        <div class="border-crisis-title">
            <span>âš”ï¸</span>
            <span>è¾¹å¢ƒå‘Šæ€¥ï¼</span>
        </div>
        <div class="border-crisis-content" id="borderCrisisContent"></div>
        <div class="loss-stats">
            <div class="loss-stat">
                <div class="loss-icon">ğŸ’€</div>
                <div class="loss-value" id="lossArmy">0</div>
                <div class="loss-label">æŸå¤±å…µåŠ›</div>
            </div>
            <div class="loss-stat">
                <div class="loss-icon">ğŸ’°</div>
                <div class="loss-value" id="lossGold">0</div>
                <div class="loss-label">è¾¹å¢ƒå†›è´¹</div>
            </div>
        </div>
        <div class="strategy-tip">
            æ•™è®­ï¼šè¿œå¾è¿œå›½æ—¶ï¼Œè¿‘é‚»ä¼šè¶è™šè€Œå…¥ï¼å…ˆç­è¿‘é‚»å°å›½æ˜¯ä¸Šç­–ã€‚
        </div>
        <button class="border-crisis-btn" onclick="game.closeBorderCrisis()">è°ƒå…µå›é˜²</button>
    </div>
    
    <!-- ç­–ç•¥æç¤ºå¼¹çª— -->
    <div class="strategy-alert" id="strategyAlert">
        <div class="strategy-title" id="strategyTitle">âš ï¸ æˆ˜ç•¥è­¦å‘Š</div>
        <div class="strategy-desc" id="strategyDesc"></div>
        <button class="strategy-btn" onclick="game.closeStrategyAlert()">æˆ‘çŸ¥é“äº†</button>
    </div>
    
    <div class="game-over" id="gameOver">
        <div class="victory-title" id="endTitle" style="display:none">å¤©ä¸‹ä¸€ç»Ÿ</div>
        <div class="defeat-title" id="endTitleDefeat" style="display:none">å¸å›½å´©å¡Œ</div>
        <div class="game-over-desc" id="endDesc"></div>
        <div class="final-stats" id="finalStats"></div>
        <button class="restart-btn" onclick="location.reload()">å†ç»Ÿå¤©ä¸‹</button>
    </div>

    <script>
        class ConquestGame {
            constructor() {
                this.turn = 1;
                this.year = 356;
                
                this.gold = 1000;
                this.army = 100;
                this.prestige = 50;
                this.globalHostility = 20;
                
                this.warDuration = {};
                this.currentTarget = null;
                
                this.coalitionActive = false;
                this.coalitionMembers = [];
                this.coalitionCountdown = 0;
                
                this.greatPowerPenalty = {};
                this.internalCrisis = false;
                this.crisisCountdown = 0;
                
                // å®šä¹‰è¿‘é‚»å›½å®¶ï¼ˆç”¨äºè¾¹å¢ƒå‘Šæ€¥åˆ¤æ–­ï¼‰
                this.nearStates = ['éŸ©', 'é­'];
                // å®šä¹‰è¿œå›½
                this.farStates = ['æ¥š', 'é½'];
                
                this.states = {
                    'éŸ©': { 
                        name: 'éŸ©', 
                        power: 40, maxPower: 40,
                        resistance: 30, stability: 60,
                        status: 'independent', alliance: null,
                        distance: 'è¿‘é‚»', size: 'å°å›½',
                        vassalYears: 0,
                        isGreatPower: false
                    },
                    'é­': { 
                        name: 'é­', 
                        power: 60, maxPower: 60,
                        resistance: 50, stability: 70,
                        status: 'independent', alliance: null,
                        distance: 'è¿‘é‚»', size: 'ä¸­ç­‰',
                        vassalYears: 0,
                        isGreatPower: false
                    },
                    'èµµ': { 
                        name: 'èµµ', 
                        power: 70, maxPower: 70,
                        resistance: 60, stability: 65,
                        status: 'independent', alliance: null,
                        distance: 'ä¸­ç­‰', size: 'ä¸­ç­‰',
                        vassalYears: 0,
                        isGreatPower: false
                    },
                    'æ¥š': { 
                        name: 'æ¥š', 
                        power: 90, maxPower: 90,
                        resistance: 70, stability: 50,
                        status: 'independent', alliance: null,
                        distance: 'è¿œå›½', size: 'å¤§å›½',
                        vassalYears: 0,
                        isGreatPower: true
                    },
                    'é½': { 
                        name: 'é½', 
                        power: 85, maxPower: 85,
                        resistance: 65, stability: 75,
                        status: 'independent', alliance: null,
                        distance: 'è¿œå›½', size: 'å¤§å›½',
                        vassalYears: 0,
                        isGreatPower: true
                    },
                    'ç‡•': { 
                        name: 'ç‡•', 
                        power: 55, maxPower: 55,
                        resistance: 40, stability: 60,
                        status: 'independent', alliance: null,
                        distance: 'ä¸­ç­‰', size: 'å°å›½',
                        vassalYears: 0,
                        isGreatPower: false
                    }
                };
                
                this.selected = null;
                this.gameOver = false;
                this.annexedOrder = [];
                // è®°å½•æ˜¯å¦å·²ç»è§¦å‘è¿‡è¾¹å¢ƒå‘Šæ€¥ï¼ˆæ¯ä¸ªè¿œå›½åªè§¦å‘ä¸€æ¬¡ï¼‰
                this.borderCrisisTriggered = { 'æ¥š': false, 'é½': false };
                
                this.init();
            }
            
            init() {
                this.render();
                this.updateUI();
                this.log('ç§¦ç‹ç»§ä½ï¼Œå…­å›½å‰²æ®ã€‚è¿œäº¤è¿‘æ”»ï¼Œå„ä¸ªå‡»ç ´ï¼Œä¸€ç»Ÿå¤©ä¸‹ï¼', 'event');
                this.log('è­¦å‘Šï¼šå¯¹ä¸€å›½ç”¨å…µè¶…è¿‡3æ¬¡ï¼Œå°†è§¦å‘å…­å›½åˆçºµåæ”»ï¼', 'warning');
                this.log('æç¤ºï¼šè¿œå¾è¿œå›½æ—¶ï¼Œè¿‘é‚»æœªå¹³å¿…é­è¾¹å¢ƒè¢­å‡»ï¼', 'strategy');
            }
            
            render() {
                const grid = document.getElementById('statesGrid');
                grid.innerHTML = '';
                
                Object.values(this.states).forEach(state => {
                    if (state.status === 'annexed') return;
                    
                    const card = document.createElement('div');
                    const isSelected = this.selected === state.name;
                    const isBeingAttacked = this.warDuration[state.name] > 0;
                    
                    let statusClass = state.status;
                    if (isBeingAttacked) statusClass += ' being-attacked';
                    if (state.isGreatPower && state.status !== 'annexed') statusClass += ' great-power';
                    
                    // è·ç¦»æ ·å¼ç±»
                    let distanceClass = '';
                    if (state.distance === 'è¿‘é‚»') distanceClass = 'distance-near';
                    else if (state.distance === 'ä¸­ç­‰') distanceClass = 'distance-mid';
                    else if (state.distance === 'è¿œå›½') distanceClass = 'distance-far';
                    
                    let statusText = {
                        'independent': 'ç‹¬ç«‹',
                        'vassal': 'é™„åº¸',
                        'allied-against': 'æŠ—ç§¦åŒç›Ÿ'
                    }[state.status] || 'ç‹¬ç«‹';
                    
                    let badgeClass = `badge-${state.status}`;
                    
                    card.className = `state-card ${statusClass} ${isSelected ? 'selected' : ''}`;
                    card.onclick = () => this.selectState(state.name);
                    
                    let warInfo = '';
                    if (isBeingAttacked) {
                        const times = this.warDuration[state.name];
                        const warning = times >= 2 ? 'âš ï¸' : '';
                        warInfo = `<div class="war-duration">${warning} å·²ç”¨å…µ ${times} æ¬¡ ${warning}</div>`;
                    }
                    
                    let vassalInfo = '';
                    if (state.status === 'vassal') {
                        vassalInfo = `<div style="margin-top:5px;font-size:0.7rem;color:#ffd700;">å·²è‡£æœ ${state.vassalYears} å¹´ï¼Œå¯åå¹¶</div>`;
                    }
                    
                    let greatPowerWarning = '';
                    if (state.isGreatPower && state.status === 'independent') {
                        greatPowerWarning = `<div style="margin-top:5px;font-size:0.7rem;color:#9c27b0;font-weight:600;">âš ï¸ å¤§å›½ - æ”»ä¼éœ€è°¨æ…</div>`;
                    }
                    
                    // åˆ é™¤åå¹¶éš¾åº¦æ˜¾ç¤ºï¼ˆç§»é™¤äº† ${isSelected ? `<div...>åå¹¶éš¾åº¦...</div>` : ''} è¿™è¡Œï¼‰
                    card.innerHTML = `
                        <div class="state-header">
                            <div class="state-name">${state.name}å›½</div>
                            <div class="state-status-badge ${badgeClass}">${statusText}</div>
                        </div>
                        <div class="distance-badge ${distanceClass}">
                            <span class="distance-icon"></span>
                            <span>${state.distance}</span>
                            <span class="size-tag">[${state.size}]</span>
                        </div>
                        <div class="state-stats">
                            <div>
                                <div class="stat-row">
                                    <span>å›½åŠ›</span>
                                    <span class="stat-value-highlight">${Math.floor(state.power)}/${state.maxPower}</span>
                                </div>
                                <div class="state-bar">
                                    <div class="state-bar-fill fill-power" style="width: ${(state.power/state.maxPower)*100}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="stat-row">
                                    <span>ç¨³å®š</span>
                                    <span class="stat-value-highlight">${Math.floor(state.stability)}%</span>
                                </div>
                                <div class="state-bar">
                                    <div class="state-bar-fill fill-stability" style="width: ${state.stability}%"></div>
                                </div>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <div class="stat-row">
                                    <span>æŠµæŠ—æ„å¿—</span>
                                    <span style="color:${state.resistance > 70 ? '#e94560' : state.resistance > 40 ? '#ffd700' : '#4ade80'}">${Math.floor(state.resistance)}%</span>
                                </div>
                                <div class="state-bar">
                                    <div class="state-bar-fill fill-resistance" style="width: ${state.resistance}%"></div>
                                </div>
                            </div>
                        </div>
                        ${state.alliance ? `<div class="alliance-indicator">ğŸ”— ä¸ ${state.alliance}å›½ åˆçºµåŒç›Ÿ</div>` : ''}
                        ${warInfo}
                        ${vassalInfo}
                        ${greatPowerWarning}
                    `;
                    
                    grid.appendChild(card);
                });
                
                const annexed = Object.values(this.states).filter(s => s.status === 'annexed');
                if (annexed.length > 0) {
                    const annexedDiv = document.createElement('div');
                    annexedDiv.style.gridColumn = '1 / -1';
                    annexedDiv.style.marginTop = '10px';
                    annexedDiv.style.padding = '15px';
                    annexedDiv.style.background = 'rgba(233,69,96,0.1)';
                    annexedDiv.style.borderRadius = '10px';
                    annexedDiv.style.border = '1px solid rgba(233,69,96,0.3)';
                    annexedDiv.innerHTML = `
                        <div style="color:#e94560;font-size:0.9rem;margin-bottom:10px;font-weight:600;">å·²åå¹¶é¢†åœŸï¼ˆ${annexed.length}/6ï¼‰</div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;">
                            ${annexed.map(s => `
                                <div style="background:rgba(0,0,0,0.3);padding:8px 15px;border-radius:20px;font-size:0.85rem;color:#666;border:1px solid rgba(255,255,255,0.1);">
                                    <span style="color:#e94560;font-weight:700;">${s.name}</span> éƒ¡
                                </div>
                            `).join('')}
                        </div>
                    `;
                    grid.appendChild(annexedDiv);
                }
            }
            
            calculateDifficulty(state) {
                if (state.status === 'vassal') return 'å®¹æ˜“ï¼ˆå·²è‡£æœï¼‰';
                
                let powerRatio = state.power / Math.max(1, this.army * 0.8);
                let resistanceMod = state.resistance / 100;
                let allianceMod = state.alliance ? 1.5 : 1;
                let warBonus = (this.warDuration[state.name] || 0) * 0.1;
                
                let greatPowerMod = 1;
                if (state.isGreatPower) {
                    greatPowerMod = 1.5;
                    if (this.army < 150) {
                        greatPowerMod = 2.0;
                    }
                }
                
                const score = (powerRatio * 0.4 + resistanceMod * 0.4) * allianceMod * greatPowerMod - warBonus;
                
                if (score < 0.3) return 'ææ˜“';
                if (score < 0.5) return 'å®¹æ˜“';
                if (score < 0.7) return 'ä¸­ç­‰';
                if (score < 0.9) return 'å›°éš¾';
                if (score < 1.2) return 'è‰°éš¾';
                if (score < 1.5) return state.isGreatPower ? 'æéš¾ï¼ˆå¤§å›½å®åŠ›ï¼‰' : 'æéš¾';
                return state.isGreatPower ? 'å‡ ä¹ä¸å¯èƒ½ï¼ˆå…ˆå–è¿‘é‚»ï¼‰' : 'æéš¾ï¼ˆé•¿æœŸæˆ˜äº‰ï¼‰';
            }
            
            selectState(name) {
                if (this.gameOver) return;
                const state = this.states[name];
                if (state.status === 'annexed') return;
                
                this.selected = name;
                
                this.updateTargetInfo();
                this.render();
                this.updateButtons();
            }
            
            showStrategyAlert(title, desc) {
                document.getElementById('strategyTitle').textContent = title;
                document.getElementById('strategyDesc').innerHTML = desc;
                document.getElementById('strategyAlert').classList.add('show');
                document.getElementById('overlay').classList.add('show');
            }
            
            closeStrategyAlert() {
                document.getElementById('strategyAlert').classList.remove('show');
                document.getElementById('overlay').classList.remove('show');
            }
            
            // æ£€æŸ¥å¹¶è§¦å‘è¾¹å¢ƒå‘Šæ€¥
            checkBorderCrisis(targetName) {
                const state = this.states[targetName];
                
                // åªæœ‰æ”»æ‰“è¿œå›½ï¼ˆæ¥šã€é½ï¼‰æ—¶æ‰å¯èƒ½è§¦å‘
                if (!this.farStates.includes(targetName)) return false;
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è¿‘é‚»å›½å®¶å­˜åœ¨ä¸”æœªè¢«åå¹¶ï¼ˆéŸ©ã€é­ï¼‰
                const activeNearStates = this.nearStates.filter(name => {
                    const s = this.states[name];
                    return s && s.status !== 'annexed' && s.status !== 'vassal';
                });
                
                if (activeNearStates.length === 0) return false;
                
                // æ¯ä¸ªè¿œå›½åªè§¦å‘ä¸€æ¬¡è¾¹å¢ƒå‘Šæ€¥
                if (this.borderCrisisTriggered[targetName]) return false;
                
                this.borderCrisisTriggered[targetName] = true;
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªè¿‘é‚»ä½œä¸ºè¢­å‡»è€…
                const attacker = activeNearStates[Math.floor(Math.random() * activeNearStates.length)];
                
                // è®¡ç®—æŸå¤±ï¼ˆåŸºäºå½“å‰å…µåŠ›å’Œé‡‘é’±çš„ä¸€å®šæ¯”ä¾‹ï¼‰
                const armyLoss = Math.floor(25 + Math.random() * 20); // 25-45å…µåŠ›
                const goldLoss = Math.floor(80 + Math.random() * 40); // 80-120é‡‘
                
                // åº”ç”¨æŸå¤±
                this.army = Math.max(0, this.army - armyLoss);
                this.gold = Math.max(0, this.gold - goldLoss);
                
                // æ˜¾ç¤ºå¼¹çª—
                this.showBorderCrisis(attacker, targetName, armyLoss, goldLoss);
                
                return true;
            }
            
            showBorderCrisis(attacker, target, armyLoss, goldLoss) {
                const content = `ç§¦å†›ä¸»åŠ›è¿œå¾åœ¨å¤–ï¼Œ<span class="highlight">${attacker}å›½</span>è¶æœºè¢­å‡»ç§¦å›½è¾¹å¢ƒï¼<br><br>
                                è¾¹å¢ƒå®ˆå†›å¯¡ä¸æ•Œä¼—ï¼ŒæŸå¤±æƒ¨é‡ï¼š`;
                
                document.getElementById('borderCrisisContent').innerHTML = content;
                document.getElementById('lossArmy').textContent = armyLoss;
                document.getElementById('lossGold').textContent = goldLoss;
                
                document.getElementById('borderCrisisAlert').classList.add('show');
                document.getElementById('overlay').classList.add('show');
                
                this.log(`âš ï¸ è¾¹å¢ƒå‘Šæ€¥ï¼ç§¦å†›è¿œå¾${target}å›½ï¼Œ${attacker}å›½è¶è™šè€Œå…¥ï¼ŒæŸå¤±${armyLoss}å…µåŠ›å’Œ${goldLoss}é‡‘ï¼`, 'warning');
            }
            
            closeBorderCrisis() {
                document.getElementById('borderCrisisAlert').classList.remove('show');
                document.getElementById('overlay').classList.remove('show');
                this.updateUI();
            }
            
            updateTargetInfo() {
                const info = document.getElementById('targetInfo');
                if (!this.selected) {
                    info.classList.remove('active');
                    return;
                }
                
                const state = this.states[this.selected];
                info.classList.add('active');
                
                document.getElementById('targetName').textContent = state.name + 'å›½';
                document.getElementById('targetStatus').textContent = {
                    'independent': state.isGreatPower ? 'ç‹¬ç«‹å¤§å›½' : 'ç‹¬ç«‹è¯¸ä¾¯',
                    'vassal': 'ç§¦å›½é™„åº¸',
                    'allied-against': 'æŠ—ç§¦åŒç›Ÿæˆå‘˜'
                }[state.status] || 'ç‹¬ç«‹è¯¸ä¾¯';
                
                document.getElementById('targetPower').textContent = `${Math.floor(state.power)}/${state.maxPower} (${Math.floor((state.power/state.maxPower)*100)}%)`;
                document.getElementById('targetResistance').textContent = Math.floor(state.resistance) + '%' + (state.resistance > 70 ? ' (å¼ºçƒˆæŠµæŠ—)' : state.resistance > 40 ? ' (çŠ¹è±«ä¸å†³)' : ' (æ°‘å¿ƒæ¶£æ•£)');
                document.getElementById('targetState').textContent = state.alliance ? `ä¸${state.alliance}å›½ç»“ç›Ÿï¼ˆåˆçºµï¼‰` : (this.warDuration[this.selected] > 0 ? `å·²ç”¨å…µ${this.warDuration[this.selected]}æ¬¡` : 'å­¤ç«‹æ— æ´ï¼ˆå¯ç ´ï¼‰');
                document.getElementById('targetDifficulty').textContent = this.calculateDifficulty(state);
                
                const militaryCost = document.getElementById('militaryCost');
                if (state.isGreatPower && state.status === 'independent') {
                    militaryCost.textContent = '-60âš”ï¸ï¼ˆå¤§å›½ï¼‰';
                } else {
                    militaryCost.textContent = '-40âš”ï¸';
                }
                
                const annexBtn = document.getElementById('btnAnnex');
                const annexText = document.getElementById('annexBtnText');
                const annexCost = document.getElementById('annexBtnCost');
                
                if (state.status === 'vassal') {
                    annexText.textContent = 'åå¹¶é™„åº¸';
                    annexCost.textContent = 'éš¾åº¦-30%';
                } else if (state.isGreatPower) {
                    annexText.textContent = 'æ”»ç­å¤§å›½';
                    annexCost.textContent = 'æŸè€—å·¨å¤§';
                } else {
                    annexText.textContent = 'å¼ºè¡Œåå¹¶';
                    annexCost.textContent = 'å¤§è§„æ¨¡æˆ˜äº‰';
                }
            }
            
            act(type) {
                if (!this.selected || this.gameOver) return;
                const state = this.states[this.selected];
                
                // å¦‚æœæ˜¯æ”»æ‰“è¿œå›½ï¼ˆæ¥šæˆ–é½ï¼‰ï¼Œå…ˆæ£€æŸ¥è¾¹å¢ƒå‘Šæ€¥
                if ((type === 'military' || type === 'annex') && this.farStates.includes(this.selected)) {
                    this.checkBorderCrisis(this.selected);
                }
                
                let message = '';
                let logType = 'diplomacy';
                
                // è®°å½•ç”¨å…µï¼ˆå¤–äº¤æ–½å‹å’Œé‡é‡‘æ”¶ä¹°ä¸ç®—ç”¨å…µï¼‰
                if (type !== 'diplomacy' && type !== 'bribe') {
                    if (!this.warDuration[this.selected]) {
                        this.warDuration[this.selected] = 0;
                    }
                    this.warDuration[this.selected]++;
                    this.currentTarget = this.selected;
                    
                    if (state.isGreatPower) {
                        this.triggerGreatPowerCrisis(state.name);
                    }
                }
                
                switch(type) {
                    case 'diplomacy':
                        if (this.gold < 150) return;
                        this.gold -= 150;
                        
                        let resistDrop = 15 + Math.floor(Math.random() * 10);
                        if (state.isGreatPower) {
                            resistDrop = Math.floor(resistDrop * 0.6);
                        }
                        state.resistance = Math.max(0, state.resistance - resistDrop);
                        
                        const canVassal = (state.resistance < 20 && state.power < state.maxPower * 0.6 && !state.alliance) || state.resistance < 10;
                        
                        if (canVassal && state.status !== 'vassal') {
                            state.status = 'vassal';
                            state.vassalYears = 0;
                            message = `ğŸ¤ ${state.name}å›½ä¸å ªå‹åŠ›ï¼Œæ„¿ä¸ºç§¦å›½é™„åº¸ï¼Œç§°è‡£çº³è´¡ï¼æ¯å¹´æä¾›40é‡‘+15å†›ã€‚`;
                            this.prestige += 8;
                            logType = 'annex';
                            
                            delete this.warDuration[this.selected];
                            this.currentTarget = null;
                        } else {
                            message = `å¯¹${state.name}å›½æ–½åŠ å¤–äº¤å‹åŠ›ï¼Œå…¶æŠµæŠ—æ„å¿—ä¸‹é™${resistDrop}ç‚¹ã€‚`;
                            if (state.status === 'vassal') {
                                message = `${state.name}å›½å·²æ˜¯é™„åº¸ï¼Œç»§ç»­æ–½å‹å¯å‡†å¤‡åå¹¶ã€‚`;
                            } else if (state.alliance) {
                                message += ' ä½†åˆçºµåŒç›Ÿä½¿å…¶æœ‰æ‰€ä¾ä»—ã€‚';
                                this.globalHostility += 5;
                            } else if (state.isGreatPower) {
                                message += ' ä½†å¤§å›½æ ¹åŸºæ·±åšï¼Œæ•ˆæœæœ‰é™ã€‚';
                            }
                        }
                        break;
                        
                    case 'bribe':
                        if (this.gold < 250) return;
                        this.gold -= 250;
                        logType = 'economy';
                        
                        let powerDrop = 20 + Math.floor(Math.random() * 15);
                        if (state.isGreatPower) {
                            powerDrop = Math.floor(powerDrop * 0.7);
                        }
                        state.power = Math.max(10, state.power - powerDrop);
                        state.stability = Math.max(20, state.stability - 10);
                        
                        message = `ğŸ’° é‡é‡‘æ”¶ä¹°${state.name}å›½æƒè´µï¼Œå›½åŠ›å‰Šå¼±${powerDrop}ç‚¹ï¼Œæ°‘å¿ƒä¸ç¨³ã€‚`;
                        
                        if (state.isGreatPower) {
                            message += ' ä½†å¤§å›½æ ¹åŸºæ·±åšï¼Œæ•ˆæœæœ‰é™ã€‚';
                        }
                        
                        if (state.alliance && Math.random() > 0.5) {
                            const ally = this.states[state.alliance];
                            ally.alliance = null;
                            state.alliance = null;
                            message += ` åˆ©ç›Šå½“å‰ï¼Œ${state.name}å›½ä¸${ally.name}å›½åˆçºµç ´è£‚ï¼`;
                            this.prestige += 10;
                        }
                        
                        this.globalHostility += 3;
                        break;
                        
                    case 'subvert':
                        if (this.gold < 200 || this.army < 10) return;
                        this.gold -= 200;
                        this.army -= 10;
                        logType = 'military';
                        
                        let stabilityDrop = 25;
                        let resistanceDrop = 15;
                        let powerDropSpy = 10;
                        
                        if (state.isGreatPower) {
                            stabilityDrop = 15;
                            resistanceDrop = 10;
                            powerDropSpy = 5;
                        }
                        
                        state.stability = Math.max(10, state.stability - stabilityDrop);
                        state.resistance = Math.max(10, state.resistance - resistanceDrop);
                        state.power = Math.max(10, state.power - powerDropSpy);
                        
                        message = `ğŸ—¡ï¸ é—´è°æ¸—é€${state.name}å›½ï¼Œåˆ¶é€ æ°‘å˜ï¼Œç¨³å®šæ€§æš´è·Œï¼`;
                        
                        if (state.isGreatPower) {
                            message += ' ä½†å¤§å›½æ ¹åŸºæ·±åšï¼Œæ•ˆæœæœ‰é™ã€‚';
                        }
                        
                        if (state.stability < 30) {
                            message += ' è¯¥å›½é™·å…¥å†…ä¹±ï¼Œæ— åŠ›æŠµæŠ—ã€‚';
                            this.prestige += 5;
                        }
                        
                        this.globalHostility += 5;
                        break;
                        
                    case 'military':
                        let armyCost = 40;
                        if (state.isGreatPower) {
                            armyCost = 60;
                        }
                        
                        if (this.army < armyCost) return;
                        this.army -= armyCost;
                        logType = 'military';
                        
                        let damage = 30 + Math.floor(this.prestige * 0.3);
                        if (state.isGreatPower) {
                            damage = Math.floor(damage * 0.7);
                        }
                        
                        state.power = Math.max(5, state.power - damage);
                        state.resistance = Math.min(100, state.resistance + 5);
                        
                        message = `âš”ï¸ ç§¦å†›å‡ºå‡»ï¼Œå¤§ç ´${state.name}å›½å†›é˜Ÿï¼Œå›½åŠ›æŸå¤±${damage}ç‚¹ï¼`;
                        
                        if (state.isGreatPower) {
                            message += ' ä½†å¤§å›½å®åŠ›é›„åšï¼Œç§¦å†›æŸè€—å·¨å¤§ï¼';
                            const counterDamage = 15 + Math.floor(Math.random() * 10);
                            this.army = Math.max(0, this.army - counterDamage);
                            this.gold = Math.max(0, this.gold - 50);
                            message += ` æ•Œå†›åå‡»ï¼Œç§¦å†›å†æŸå¤±${counterDamage}å…µåŠ›ï¼Œå†›è´¹æ¿€å¢ï¼`;
                        }
                        
                        if (state.alliance) {
                            message += ' åˆçºµåŒç›Ÿéœ‡æ€’ï¼';
                            this.globalHostility += 15;
                        }
                        
                        if (this.warDuration[this.selected] >= 2) {
                            state.stability = Math.max(20, state.stability - 10);
                            message += ` å¤šæ¬¡ç”¨å…µä½¿${state.name}å›½æ°‘ç”Ÿå‡‹æ•ã€‚`;
                        }
                        
                        break;
                        
                    case 'annex':
                        let canAnnex = false;
                        let successRate = 0.7;
                        
                        if (state.status === 'vassal') {
                            canAnnex = state.vassalYears >= 2 || state.resistance < 30;
                            successRate = 0.85;
                            if (state.vassalYears < 1) {
                                message = `${state.name}å›½åˆšè‡£æœä¸ä¹…ï¼Œæ°‘å¿ƒæœªé™„ï¼Œå»ºè®®å†ç­‰å¾…${2-state.vassalYears}å¹´ã€‚`;
                                this.log(message, 'warning');
                                return;
                            }
                        } else {
                            canAnnex = state.power <= 30 && (state.resistance <= 50 || state.stability <= 40);
                        }
                        
                        if (state.isGreatPower && state.status !== 'vassal') {
                            canAnnex = state.power <= 20 && state.resistance <= 30;
                            successRate = 0.5;
                        }
                        
                        if (!canAnnex) {
                            if (state.isGreatPower) {
                                this.log(`âš ï¸ ${state.name}å›½ä¹ƒå½“ä¸–å¤§å›½ï¼Œæ ¹åŸºæ·±åšï¼Œå¼ºè¡Œæ”»ä¼å¿…é­æƒ¨è´¥ï¼å»ºè®®å…ˆå‰Šå¼±å…¶å›½åŠ›è‡³20ä»¥ä¸‹ã€‚`, 'military');
                            } else {
                                this.log(`âš ï¸ ${state.name}å›½å°šæœ‰æŠµæŠ—èƒ½åŠ›ï¼Œå¼ºè¡Œåå¹¶å¯èƒ½å¤±è´¥ï¼å»ºè®®ç»§ç»­å‰Šå¼±ã€‚`, 'military');
                            }
                            return;
                        }
                        
                        if (state.power > 20) successRate -= 0.1;
                        if (state.resistance > 30) successRate -= 0.15;
                        if (state.stability > 50) successRate -= 0.1;
                        if (state.alliance) successRate -= 0.2;
                        if (this.warDuration[this.selected] >= 3) successRate += 0.15;
                        if (state.isGreatPower) successRate -= 0.2;
                        
                        successRate = Math.max(0.3, Math.min(0.95, successRate));
                        
                        if (Math.random() > successRate) {
                            // åå¹¶å¤±è´¥ - ä¸å†é‡å¤å¢åŠ ç”¨å…µæ¬¡æ•°ï¼
                            let failDamage = 30;
                            if (state.isGreatPower) {
                                failDamage = 50;
                            }
                            this.army -= failDamage;
                            this.prestige -= 10;
                            message = `âŒ åå¹¶${state.name}å›½å¤±è´¥ï¼é­é‡é¡½å¼ºæŠµæŠ—ï¼Œç§¦å†›æŸå¤±æƒ¨é‡ï¼Œå¨æœ›ä¸‹é™ã€‚`;
                            logType = 'military';
                            state.resistance = 100;
                            state.stability = Math.min(100, state.stability + 20);
                            this.globalHostility += 20;
                            
                            // åˆ é™¤äº†é‡å¤çš„ï¼šthis.warDuration[this.selected] = (this.warDuration[this.selected] || 0) + 1;
                            
                            if (state.isGreatPower) {
                                message += ' å¤§å›½æ ¹åŸºæ·±åšï¼Œéä¸€æœä¸€å¤•å¯ç ´ï¼';
                            }
                        } else {
                            // æˆåŠŸåå¹¶
                            const wasVassal = state.status === 'vassal';
                            state.status = 'annexed';
                            this.annexedOrder.push(state.name);
                            
                            delete this.warDuration[this.selected];
                            if (this.currentTarget === this.selected) {
                                this.currentTarget = null;
                            }
                            
                            let loot = state.maxPower * (wasVassal ? 2 : 3);
                            let armyGain = wasVassal ? 10 : 25;
                            
                            if (state.isGreatPower) {
                                loot = Math.floor(loot * 1.5);
                                armyGain = Math.floor(armyGain * 1.3);
                            }
                            
                            this.gold += loot;
                            this.army += armyGain;
                            
                            message = `ğŸ›ï¸ å¤§æ·ï¼${state.name}å›½${wasVassal ? 'æ­£å¼å¹¶å…¥' : 'ç­äº¡ï¼Œçº³å…¥'}ç§¦åœŸï¼è·å¾—${loot}é‡‘ï¼Œæ”¶ç¼–å†›åŠ›${armyGain}ã€‚`;
                            logType = 'annex';
                            
                            if (state.isGreatPower) {
                                message += ' ç­æ­¤å¤§å›½ï¼Œå…­å›½éœ‡åŠ¨ï¼';
                                this.prestige += 30;
                            }
                            
                            Object.values(this.states).forEach(s => {
                                if (s.status !== 'annexed' && s.name !== state.name) {
                                    if (this.areNeighbors(s.name, state.name)) {
                                        s.resistance = Math.max(0, s.resistance - 15);
                                        s.stability = Math.max(20, s.stability - 10);
                                    } else {
                                        s.resistance = Math.min(100, s.resistance + 10);
                                    }
                                }
                            });
                            
                            this.globalHostility += 15;
                            if (!state.isGreatPower) {
                                this.prestige += 20;
                            }
                        }
                        break;
                }
                
                this.log(message, logType);
                
                this.checkCoalitionTrigger();
                
                this.checkWin();
                this.render();
                this.updateUI();
            }
            
            triggerGreatPowerCrisis(targetName) {
                const warTimes = this.warDuration[targetName] || 1;
                
                if (warTimes === 1 && Math.random() > 0.3) {
                    this.internalCrisis = true;
                    this.crisisCountdown = 2;
                    
                    const neighbors = {
                        'æ¥š': ['é½'],
                        'é½': ['é­', 'ç‡•', 'æ¥š']
                    };
                    
                    const potentialAttackers = neighbors[targetName]?.filter(n => 
                        this.states[n] && this.states[n].status === 'independent'
                    ) || [];
                    
                    if (potentialAttackers.length > 0) {
                        const attacker = potentialAttackers[Math.floor(Math.random() * potentialAttackers.length)];
                        const damage = 20 + Math.floor(Math.random() * 15);
                        
                        this.army = Math.max(0, this.army - damage);
                        this.gold = Math.max(0, this.gold - 80);
                        
                        this.log(`âš ï¸ ç§¦å†›ä¸»åŠ›æ”»${targetName}ï¼Œ${attacker}å›½è¶è™šè€Œå…¥ï¼è¾¹å¢ƒå‘Šæ€¥ï¼ŒæŸå¤±${damage}å…µåŠ›ï¼`, 'warning');
                    }
                }
                
                if (warTimes >= 2) {
                    const damage = 15 * warTimes;
                    this.army = Math.max(0, this.army - damage);
                    this.gold = Math.max(0, this.gold - 50 * warTimes);
                    
                    this.log(`âš ï¸ æ”»${targetName}å¤šæ¬¡ç”¨å…µï¼Œå¸ˆè€å…µç–²ï¼Œå¤šå›½è ¢è ¢æ¬²åŠ¨ï¼å›½åŠ›æŒç»­æŸè€—...`, 'warning');
                }
            }
            
            checkCoalitionTrigger() {
                let maxWarTimes = 0;
                let longestWarState = null;
                
                Object.entries(this.warDuration).forEach(([stateName, times]) => {
                    if (times > maxWarTimes) {
                        maxWarTimes = times;
                        longestWarState = stateName;
                    }
                });
                
                const isGreatPower = this.states[longestWarState]?.isGreatPower || false;
                const triggerThreshold = isGreatPower ? 2 : 3;
                
                if (maxWarTimes >= triggerThreshold && !this.coalitionActive) {
                    const triggerChance = maxWarTimes === triggerThreshold ? (isGreatPower ? 0.8 : 0.6) : 0.9;
                    
                    if (Math.random() < triggerChance) {
                        this.triggerCoalition(longestWarState, maxWarTimes);
                    } else if (maxWarTimes === triggerThreshold) {
                        this.log(`âš ï¸ å¯¹${longestWarState}å›½ç”¨å…µå·²${maxWarTimes}æ¬¡ï¼Œå„å›½å¼€å§‹è­¦è§‰ï¼Œä¸‹æ¬¡å¯èƒ½ç»„æˆåˆçºµè”å†›ï¼`, 'warning');
                    }
                }
            }
            
            triggerCoalition(targetState, warTimes) {
                // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å›½å®¶ç»„æˆè”å†›ï¼ˆè‡³å°‘2ä¸ªï¼‰
                const available = Object.values(this.states).filter(s => 
                    s.status !== 'annexed' && s.status !== 'vassal' && s.name !== targetState
                );
                
                if (available.length < 2) {
                    this.log(`å„å›½è‡ªé¡¾ä¸æš‡ï¼Œæ— åŠ›ç»„æˆåˆçºµè”å†›ã€‚`, 'diplomacy');
                    return;
                }
                
                this.coalitionActive = true;
                
                const isGreatPower = this.states[targetState]?.isGreatPower || false;
                const memberCount = Math.min(available.length, isGreatPower ? 3 : (warTimes >= 3 ? 3 : 2));
                
                available.sort((a, b) => b.resistance - a.resistance);
                this.coalitionMembers = available.slice(0, memberCount).map(s => s.name);
                
                this.coalitionMembers.forEach(name => {
                    this.states[name].status = 'allied-against';
                    this.states[name].alliance = targetState;
                });
                
                this.coalitionCountdown = 2 + Math.floor(Math.random() * 2);
                
                const memberStr = this.coalitionMembers.map(n => n + 'å›½').join('ã€');
                const desc = `ç”±äºå¯¹${targetState}å›½ç”¨å…µå·²è¾¾${warTimes}æ¬¡ï¼Œ${memberStr}ç»„æˆåˆçºµè”å†›ï¼Œä»å¤šæ–¹å‘ç§¦å†›å‘èµ·åæ”»ï¼<br><br>åˆçºµå°†æŒç»­${this.coalitionCountdown}å¹´ï¼ŒæœŸé—´å„å›½å›½åŠ›æ¢å¤åŠ é€Ÿï¼Œç§¦å†›å°†æ‰¿å—å·¨å¤§å‹åŠ›ï¼`;
                
                document.getElementById('coalitionDesc').innerHTML = desc;
                document.getElementById('coalitionAlert').classList.add('show');
                document.getElementById('overlay').classList.add('show');
                
                this.log(`ğŸš¨ åˆçºµè”å†›ç»„æˆï¼${memberStr}è”åˆåæ”»ç§¦å›½ï¼`, 'coalition');
                
                let damage = 30 * this.coalitionMembers.length;
                if (this.states[targetState]?.isGreatPower) {
                    damage = Math.floor(damage * 1.3);
                }
                this.army = Math.max(0, this.army - damage);
                this.gold = Math.max(0, this.gold - 100);
                
                this.log(`åˆçºµè”å†›æ”»åŠ¿å‡¶çŒ›ï¼Œç§¦å†›æŸå¤±${damage}å…µåŠ›ï¼Œè¾¹å¢ƒå†›è´¹æ¿€å¢ï¼`, 'military');
            }
            
            closeCoalitionAlert() {
                document.getElementById('coalitionAlert').classList.remove('show');
                document.getElementById('overlay').classList.remove('show');
            }
            
            areNeighbors(a, b) {
                const neighbors = {
                    'éŸ©': ['é­', 'èµµ'],
                    'é­': ['éŸ©', 'èµµ', 'é½'],
                    'èµµ': ['éŸ©', 'é­', 'ç‡•'],
                    'æ¥š': ['é½'],
                    'é½': ['é­', 'ç‡•', 'æ¥š'],
                    'ç‡•': ['èµµ', 'é½']
                };
                return neighbors[a]?.includes(b) || neighbors[b]?.includes(a);
            }
            
            endTurn() {
                if (this.gameOver) return;
                
                this.turn++;
                this.year -= 1;
                
                const vassals = Object.values(this.states).filter(s => s.status === 'vassal');
                vassals.forEach(v => {
                    v.vassalYears++;
                    this.gold += 40;
                    this.army += 15;
                });
                
                const annexedCount = Object.values(this.states).filter(s => s.status === 'annexed').length;
                const baseIncome = 100 + annexedCount * 80;
                const vassalIncome = vassals.length * 40;
                
                this.gold += baseIncome;
                // ä¿®æ”¹ï¼šæ¯å¹´å…µåŠ›å¢åŠ 40ï¼ˆåŸæ¥æ˜¯+20ï¼‰
                this.army = Math.min(200 + annexedCount * 50, this.army + 40);
                
                if (this.coalitionActive) {
                    this.coalitionCountdown--;
                    
                    this.coalitionMembers.forEach(name => {
                        const s = this.states[name];
                        s.power = Math.min(s.maxPower, s.power + 15);
                        s.stability = Math.min(100, s.stability + 10);
                    });
                    
                    this.army -= 20;
                    this.gold -= 50;
                    
                    this.log(`åˆçºµè”å†›æŒç»­è¿›æ”»ï¼Œç§¦å†›ç–²äºåº”ä»˜...ï¼ˆå‰©ä½™${this.coalitionCountdown}å¹´ï¼‰`, 'coalition');
                    
                    if (this.coalitionCountdown <= 0) {
                        this.coalitionActive = false;
                        this.coalitionMembers.forEach(name => {
                            if (this.states[name].status === 'allied-against') {
                                this.states[name].status = 'independent';
                                this.states[name].alliance = null;
                            }
                        });
                        this.coalitionMembers = [];
                        this.log('åˆçºµåŒç›Ÿå› åˆ©ç›Šåˆ†æ­§ç“¦è§£ï¼Œå„å›½é€€å…µï¼', 'diplomacy');
                    }
                }
                
                if (this.internalCrisis) {
                    this.crisisCountdown--;
                    if (this.crisisCountdown <= 0) {
                        this.internalCrisis = false;
                    }
                }
                
                this.prestige = Math.max(0, this.prestige - 2);
                
                this.aiTurn();
                
                if (!this.coalitionActive) {
                    this.checkNaturalCoalition();
                }
                
                this.log(`å…¬å…ƒå‰${this.year}å¹´ï¼šå›½åº“æ”¶å…¥${baseIncome+vassalIncome}é‡‘ï¼Œ${vassals.length}ä¸ªé™„åº¸å›½çº³è´¡ã€‚`, 'economy');
                
                this.checkWin();
                this.render();
                this.updateUI();
            }
            
            aiTurn() {
                const activeStates = Object.values(this.states).filter(s => s.status === 'independent');
                
                activeStates.forEach(state => {
                    if (state.power < state.maxPower) {
                        let recovery = this.coalitionActive ? 10 : 5;
                        if (state.isGreatPower) {
                            recovery = Math.floor(recovery * 1.3);
                        }
                        state.power = Math.min(state.maxPower, state.power + recovery);
                    }
                    if (state.stability < 100 && Math.random() > 0.5) {
                        state.stability = Math.min(100, state.stability + 5);
                    }
                    
                    if (this.globalHostility > 50 && state.resistance < 80) {
                        state.resistance = Math.min(100, state.resistance + 3);
                    }
                });
                
                if (Math.random() > 0.7) {
                    const events = [
                        { text: 'å…³ä¸­ä¸°æ”¶ï¼Œç²®è‰å……è¶³ï¼', effect: () => this.gold += 100, type: 'economy' },
                        { text: 'åå°†è®­ç»ƒæ–°å…µï¼Œç§¦å†›æˆ˜åŠ›æå‡ï¼', effect: () => { this.army += 30; this.prestige += 5; }, type: 'military' },
                        { text: 'å•†è´¾äº‘é›†ï¼Œè´¸æ˜“ç¹è£ã€‚', effect: () => this.gold += 80, type: 'economy' },
                        { text: 'è´µæ—è°‹åï¼Œæ¶ˆè€—èµ„æºå¹³æ¯ã€‚', effect: () => { this.gold -= 100; this.prestige -= 5; }, type: 'military' }
                    ];
                    const evt = events[Math.floor(Math.random() * events.length)];
                    evt.effect();
                    this.log(`ã€äº‹ä»¶ã€‘${evt.text}`, evt.type);
                }
            }
            
            checkNaturalCoalition() {
                const hostileStates = Object.values(this.states).filter(s => 
                    s.status === 'independent' && s.resistance > 75 && !s.alliance
                );
                
                if (hostileStates.length >= 2 && this.globalHostility > 60 && Math.random() > 0.7) {
                    const s1 = hostileStates[0];
                    const s2 = hostileStates[1];
                    s1.alliance = s2.name;
                    s2.alliance = s1.name;
                    s1.status = 'allied-against';
                    s2.status = 'allied-against';
                    
                    this.log(`ğŸš¨ ${s1.name}å›½ä¸${s2.name}å›½è¾¾æˆåˆçºµåŒç›Ÿï¼Œå…±åŒæŠ—ç§¦ï¼`, 'coalition');
                    this.globalHostility += 10;
                }
            }
            
            checkWin() {
                const annexed = Object.values(this.states).filter(s => s.status === 'annexed').length;
                const independent = Object.values(this.states).filter(s => s.status === 'independent').length;
                
                if (annexed === 6) {
                    const endYear = this.year;
                    const startYear = 356;
                    const yearsTaken = startYear - endYear;
                    this.endGame(true, `å†ç»${yearsTaken}å¹´ï¼ˆå…¬å…ƒå‰${startYear}å¹´è‡³å…¬å…ƒå‰${endYear}å¹´ï¼‰ï¼Œç§¦ç‹æ‰«å…­åˆï¼Œè™è§†ä½•é›„å“‰ï¼æŒ¥å‰‘å†³æµ®äº‘ï¼Œè¯¸ä¾¯å°½è¥¿æ¥ã€‚è½¦åŒè½¨ï¼Œä¹¦åŒæ–‡ï¼Œè¡ŒåŒä¼¦ï¼Œåå¤ä¸€ç»Ÿï¼`);
                    return;
                }
                
                if (this.army < 20 && this.gold < 100 && independent > 0) {
                    this.endGame(false, `ç§¦å†›ä¹…æˆ˜ç–²æƒ«ï¼Œå›½åº“ç©ºè™šï¼Œæ— åŠ›å†æˆ˜ã€‚${independent}å›½è”åˆåæ”»ï¼Œç§¦å›½å‰²åœ°æ±‚å’Œï¼Œéœ¸ä¸šä¸­è¡°...`);
                    return;
                }
                
                if (this.coalitionActive && this.army < 50 && this.gold < 200) {
                    this.endGame(false, 'åˆçºµè”å†›åŠ¿å¤§ï¼Œç§¦å†›ä¸»åŠ›è¦†ç­ï¼Œå‡½è°·å…³å¤±å®ˆã€‚ç§¦ç‹è¢«è¿«å‰²åœ°ç§°è‡£ï¼Œç»Ÿä¸€å¤§ä¸šåŒ–ä¸ºæ³¡å½±...');
                    return;
                }
            }
            
            endGame(victory, message) {
                this.gameOver = true;
                const modal = document.getElementById('gameOver');
                modal.classList.add('show');
                
                if (victory) {
                    document.getElementById('endTitle').style.display = 'block';
                    document.getElementById('endTitleDefeat').style.display = 'none';
                } else {
                    document.getElementById('endTitle').style.display = 'none';
                    document.getElementById('endTitleDefeat').style.display = 'block';
                }
                
                document.getElementById('endDesc').textContent = message;
                
                const annexed = Object.values(this.states).filter(s => s.status === 'annexed').length;
                const vassals = Object.values(this.states).filter(s => s.status === 'vassal').length;
                
                const yearsTaken = 356 - this.year;
                
                document.getElementById('finalStats').innerHTML = `
                    <div class="final-stat">
                        <div class="final-value">${yearsTaken}</div>
                        <div class="final-label">ç»Ÿä¸€è€—æ—¶ï¼ˆå¹´ï¼‰</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-value">${annexed}</div>
                        <div class="final-label">ç›´æ¥åå¹¶</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-value">${vassals}</div>
                        <div class="final-label">é™„åº¸å½’é¡º</div>
                    </div>
                `;
            }
            
            updateUI() {
                document.getElementById('resGold').textContent = Math.floor(this.gold);
                document.getElementById('resArmy').textContent = Math.floor(this.army);
                document.getElementById('resPrestige').textContent = Math.floor(this.prestige);
                document.getElementById('resFatigue').textContent = Math.floor(this.globalHostility);
                document.getElementById('resTurn').textContent = this.turn;
                
                document.getElementById('turnBadge').textContent = `å…¬å…ƒå‰ ${this.year} å¹´`;
                
                const warBanner = document.getElementById('warBanner');
                if (this.coalitionActive) {
                    warBanner.classList.add('active');
                    warBanner.textContent = `ğŸš¨ åˆçºµè¿›è¡Œä¸­ï¼${this.coalitionMembers.join('ã€')}å›½è”å†›æ­£åœ¨åæ”»ï¼ˆå‰©ä½™${this.coalitionCountdown}å¹´ï¼‰ğŸš¨`;
                } else {
                    const maxWar = Math.max(0, ...Object.values(this.warDuration));
                    if (maxWar >= 2) {
                        warBanner.classList.add('active');
                        warBanner.textContent = `âš ï¸ è­¦å‘Šï¼šå¯¹æŸå›½ç”¨å…µå·²${maxWar}æ¬¡ï¼Œå„å›½è­¦è§‰ï¼Œä¸‹æ¬¡å¯èƒ½è§¦å‘åˆçºµåæ”»ï¼âš ï¸`;
                    } else {
                        warBanner.classList.remove('active');
                    }
                }
                
                const annexed = Object.values(this.states).filter(s => s.status === 'annexed').length;
                const vassals = Object.values(this.states).filter(s => s.status === 'vassal').length;
                const independent = 6 - annexed - vassals;
                
                const progress = (annexed / 6) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressBar').textContent = Math.floor(progress) + '%';
                document.getElementById('progressText').textContent = `${annexed}/6 å›½`;
                
                document.getElementById('annexedCount').textContent = annexed;
                document.getElementById('vassalCount').textContent = vassals;
                document.getElementById('independentCount').textContent = independent;
                
                const hostilityTrend = this.globalHostility > 60 ? 'â†‘ åˆçºµé£é™©' : this.globalHostility > 40 ? 'â†’ è­¦æƒ•' : 'â†“ å¯æ§';
                document.getElementById('hostilityTrend').textContent = hostilityTrend;
                document.getElementById('hostilityTrend').style.color = this.globalHostility > 60 ? '#e94560' : this.globalHostility > 40 ? '#ffd700' : '#4ade80';
                
                this.updateButtons();
                this.updateTargetInfo();
            }
            
            updateButtons() {
                const hasTarget = this.selected !== null;
                const state = hasTarget ? this.states[this.selected] : null;
                
                document.getElementById('btnDiplomacy').disabled = !hasTarget || this.gold < 150 || state?.status === 'annexed';
                document.getElementById('btnBribe').disabled = !hasTarget || this.gold < 250 || state?.status === 'annexed';
                document.getElementById('btnSubvert').disabled = !hasTarget || this.gold < 200 || this.army < 10 || state?.status === 'annexed';
                
                let armyCost = 40;
                if (state?.isGreatPower && state?.status === 'independent') {
                    armyCost = 60;
                }
                document.getElementById('btnMilitary').disabled = !hasTarget || this.army < armyCost || state?.status === 'annexed';
                
                let canAnnex = false;
                if (hasTarget && state.status !== 'annexed') {
                    if (state.status === 'vassal') {
                        canAnnex = state.vassalYears >= 2 || state.resistance < 30;
                    } else if (state.isGreatPower) {
                        canAnnex = state.power <= 20 && state.resistance <= 30;
                    } else {
                        canAnnex = state.power <= 30 && (state.resistance <= 50 || state.stability <= 40);
                    }
                }
                document.getElementById('btnAnnex').disabled = !canAnnex;
            }
            
            log(message, type = 'normal') {
                const logDiv = document.getElementById('logContent');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `<span class="log-time">[å…¬å…ƒå‰${this.year}å¹´]</span>${message}`;
                logDiv.insertBefore(entry, logDiv.firstChild);
                
                while (logDiv.children.length > 30) {
                    logDiv.removeChild(logDiv.lastChild);
                }
            }
        }
        
        const game = new ConquestGame();
    </script>
</body>
</html>